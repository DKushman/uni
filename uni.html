<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTW Upload Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
        }
        /* Override all Tailwind orange utilities to #86bc26 */
        .text-orange-50 { color: #86bc26 !important; }
        .text-orange-100 { color: #fff !important; }
        .text-orange-500 { color: #86bc26 !important; }
        .text-orange-600 { color: #86bc26 !important; }
        .text-orange-700 { color: #86bc26 !important; }

        .bg-orange-50 { background-color: #f0f9e0 !important; }
        .bg-orange-100 { background-color: #e5f5c5 !important; }
        .bg-orange-500 { background-color: #86bc26 !important; }
        .bg-orange-600 { background-color: #76a820 !important; }
        .bg-orange-700 { background-color: #66941a !important; }

        .hover\:bg-orange-50:hover { background-color: #f0f9e0 !important; }
        .hover\:bg-orange-100:hover { background-color: #e5f5c5 !important; }
        .hover\:bg-orange-500:hover { background-color: #76a820 !important; }
        .hover\:bg-orange-600:hover { background-color: #66941a !important; }
        .hover\:text-orange-500:hover { color: #86bc26 !important; }

        .border-orange-500 { border-color: #86bc26 !important; }
        .border-orange-600 { border-color: #76a820 !important; }
        .ring-orange-200 { --tw-ring-color: #b5d866 !important; }
        .focus\:border-orange-500:focus { border-color: #86bc26 !important; }
        .focus\:ring-orange-200:focus { --tw-ring-color: #b5d866 !important; }

        .from-orange-500 { --tw-gradient-from: #86bc26 var(--tw-gradient-from-position) !important; --tw-gradient-to: rgb(134 188 38 / 0) var(--tw-gradient-to-position) !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .to-orange-600 { --tw-gradient-to: #76a820 var(--tw-gradient-to-position) !important; }
        .hover\:from-orange-600:hover { --tw-gradient-from: #76a820 var(--tw-gradient-from-position) !important; --tw-gradient-to: rgb(118 168 32 / 0) var(--tw-gradient-to-position) !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .hover\:to-orange-700:hover { --tw-gradient-to: #66941a var(--tw-gradient-to-position) !important; }

        .accent-orange-500 { accent-color: #86bc26 !important; }
        .text-orange-500 svg, .text-orange-600 svg { color: #86bc26 !important; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // SVG Icons
        const icons = {
            upload: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>`,
            check: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
            alertCircle: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            chevronLeft: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>`,
            chevronRight: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`,
            save: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>`,
            x: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
            globe: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            bot: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
            messageCircle: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`,
            send: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`,
            linkedin: `<svg class="icon" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg>`
        };

        // App State
        let state = {
            currentStep: 0,
            selectedMode: null, // 'ai', 'manual', or 'linkedin'
            language: 'de',
            errors: {},
            uploadedFiles: [],
            showSuccess: false,
            isDragging: false,
            sessionWarning: false,
            lastActivity: Date.now(),
            // Chat state
            chatOpen: false,
            chatMessages: [],
            currentQuestionIndex: 0,
            chatCompleted: false,
            // LinkedIn state
            linkedinLoginShow: false,
            linkedinLoading: false,
            linkedinProgress: 0,
            selectedLinkedInAccount: null,
            formData: {
                titel: '',
                vorname: '',
                nachname: '',
                email: '',
                telefon: '',
                fachbereich: '',
                betreff: '',
                nachricht: '',
                datenschutz: false
            }
        };

        // Chatbot questions
        const chatQuestions = {
            de: [
                { field: 'vorname', question: 'Hallo! Wie lautet Ihr Vorname?', placeholder: 'Bitte geben Sie Ihren Vornamen ein' },
                { field: 'nachname', question: 'Vielen Dank! Und wie lautet Ihr Nachname?', placeholder: 'Bitte geben Sie Ihren Nachnamen ein' },
                { field: 'email', question: 'Perfekt! Wie ist Ihre E-Mail-Adresse?', placeholder: 'z.B. max.mustermann@example.com' },
                { field: 'telefon', question: 'Haben Sie eine Telefonnummer? (Optional)', placeholder: 'Optional - Leer lassen für Überspringen' },
                { field: 'fachbereich', question: 'Welcher Fachbereich interessiert Sie?', options: ['Informatik', 'Wirtschaft', 'Technik', 'Gestaltung'], placeholder: 'Bitte wählen Sie aus' },
                { field: 'titel', question: 'Haben Sie einen Titel? (z.B. Prof., Dr.)', placeholder: 'Optional - Leer lassen für Überspringen' },
                { field: 'betreff', question: 'Worum geht es in Ihrer Anfrage?', placeholder: 'Bitte beschreiben Sie den Betreff' },
                { field: 'nachricht', question: 'Möchten Sie noch etwas ergänzen? (Optional)', placeholder: 'Optional - Leer lassen für Überspringen' },
                { field: 'datenschutz', question: 'Stimmen Sie der Datenschutzerklärung zu? (Ja/Nein)', isConfirm: true },
                { field: null, question: 'Vielen Dank! Ich fülle nun das Formular für Sie aus.', isComplete: true }
            ],
            en: [
                { field: 'vorname', question: 'Hello! What is your first name?', placeholder: 'Please enter your first name' },
                { field: 'nachname', question: 'Thank you! And what is your last name?', placeholder: 'Please enter your last name' },
                { field: 'email', question: 'Perfect! What is your email address?', placeholder: 'e.g. john.doe@example.com' },
                { field: 'telefon', question: 'Do you have a phone number? (Optional)', placeholder: 'Optional - Leave empty to skip' },
                { field: 'fachbereich', question: 'Which department interests you?', options: ['Computer Science', 'Business', 'Engineering', 'Design'], placeholder: 'Please choose' },
                { field: 'titel', question: 'Do you have a title? (e.g. Prof., Dr.)', placeholder: 'Optional - Leave empty to skip' },
                { field: 'betreff', question: 'What is your inquiry about?', placeholder: 'Please describe the subject' },
                { field: 'nachricht', question: 'Would you like to add anything else? (Optional)', placeholder: 'Optional - Leave empty to skip' },
                { field: 'datenschutz', question: 'Do you agree to the privacy policy? (Yes/No)', isConfirm: true },
                { field: null, question: 'Thank you! I will now fill out the form for you.', isComplete: true }
            ]
        };

        // Translations
        const translations = {
            de: {
                title: 'W2 Proffessur für den Fachbereich Informatik <i>(#26178)<b>',
                subtitle: 'Reichen Sie Ihre Unterlagen schnell und sicher ein',
                step0: 'Auswahl',
                step0Title: 'Wie möchten Sie fortfahren?',
                step0Description: 'Wählen Sie eine Option, um mit der Einreichung zu beginnen',
                step0AIOption: 'Mit KI reden',
                step0AIDescription: 'Lassen Sie sich von unserer KI bei der Eingabe Ihrer Daten unterstützen',
                step0ManualOption: 'Manuell eingeben',
                step0ManualDescription: 'Füllen Sie das Formular selbstständig aus',
                step0LinkedInOption: 'Von LinkedIn übertragen',
                step0LinkedInDescription: 'Übertragen Sie Ihre Daten direkt von Ihrem LinkedIn-Profil',
                saveAndContinue: 'Speichern & Weiter',
                step1: 'Persönliche Daten',
                step2: 'Dokumente hochladen',
                step3: 'Überprüfung & Absenden',
                progress: 'Schritt',
                of: 'von',
                save: 'Zwischenspeichern',
                back: 'Zurück',
                next: 'Weiter',
                submit: 'Absenden',
                titel: 'Titel',
                vorname: 'Vorname',
                nachname: 'Nachname',
                email: 'E-Mail-Adresse',
                telefon: 'Telefonnummer (optional)',
                fachbereich: 'Fachbereich',
                betreff: 'Betreff',
                nachricht: 'Nachricht (optional)',
                datenschutz: 'Ich stimme der Datenschutzerklärung zu',
                uploadTitle: 'Dokumente hochladen',
                uploadDesc: 'Ziehen Sie Dateien hierher oder klicken Sie zum Auswählen',
                uploadFormats: 'Unterstützte Formate: PDF, DOC, DOCX (max. 10 MB pro Datei)',
                uploadedFiles: 'Hochgeladene Dateien',
                reviewTitle: 'Bitte überprüfen Sie Ihre Angaben',
                reviewPersonal: 'Persönliche Daten',
                reviewDocuments: 'Dokumente',
                successTitle: 'Erfolgreich eingereicht!',
                successMessage: 'Ihre Unterlagen wurden erfolgreich übermittelt. Sie erhalten in Kürze eine Bestätigungsmail.',
                sessionWarning: 'Ihre Sitzung läuft in 5 Minuten ab. Möchten Sie verlängern?',
                extend: 'Verlängern',
                required: 'Pflichtfeld',
                invalidEmail: 'Bitte geben Sie eine gültige E-Mail-Adresse ein',
                selectOption: 'Bitte wählen...',
                selectFiles: 'Dateien auswählen',
                fachbereiche: {
                    informatik: 'Informatik',
                    wirtschaft: 'Wirtschaft',
                    technik: 'Technik',
                    design: 'Gestaltung'
                },
                linkedinLoginTitle: 'Bei LinkedIn anmelden',
                linkedinLoginDescription: 'Mit Ihrem Konto fortfahren',
                linkedinLoginContinue: 'Weiter',
                linkedinLoginCancel: 'Abbrechen'
            },
            en: {
                title: 'Document Upload Portal',
                subtitle: 'Submit your documents quickly and securely',
                step0: 'Selection',
                step0Title: 'How would you like to proceed?',
                step0Description: 'Choose an option to begin your submission',
                step0AIOption: 'Speak with AI',
                step0AIDescription: 'Let our AI assist you in entering your data',
                step0ManualOption: 'Enter manually',
                step0ManualDescription: 'Fill out the form yourself',
                step0LinkedInOption: 'Transfer from LinkedIn',
                step0LinkedInDescription: 'Transfer your data directly from your LinkedIn profile',
                saveAndContinue: 'Save & Continue',
                step1: 'Personal Information',
                step2: 'Upload Documents',
                step3: 'Review & Submit',
                progress: 'Step',
                of: 'of',
                save: 'Save Draft',
                back: 'Back',
                next: 'Next',
                submit: 'Submit',
                titel: 'Title',
                vorname: 'First Name',
                nachname: 'Last Name',
                email: 'Email Address',
                telefon: 'Phone Number (optional)',
                fachbereich: 'Department',
                betreff: 'Subject',
                nachricht: 'Message (optional)',
                datenschutz: 'I agree to the privacy policy',
                uploadTitle: 'Upload Documents',
                uploadDesc: 'Drag files here or click to select',
                uploadFormats: 'Supported formats: PDF, DOC, DOCX (max. 10 MB per file)',
                uploadedFiles: 'Uploaded Files',
                reviewTitle: 'Please review your information',
                reviewPersonal: 'Personal Information',
                reviewDocuments: 'Documents',
                successTitle: 'Successfully Submitted!',
                successMessage: 'Your documents have been successfully submitted. You will receive a confirmation email shortly.',
                sessionWarning: 'Your session will expire in 5 minutes. Would you like to extend?',
                extend: 'Extend',
                required: 'Required field',
                invalidEmail: 'Please enter a valid email address',
                selectOption: 'Please select...',
                selectFiles: 'Select Files',
                fachbereiche: {
                    informatik: 'Computer Science',
                    wirtschaft: 'Business',
                    technik: 'Engineering',
                    design: 'Design'
                },
                linkedinLoginTitle: 'Sign in to LinkedIn',
                linkedinLoginDescription: 'Continue with your account',
                linkedinLoginContinue: 'Continue',
                linkedinLoginCancel: 'Cancel'
            }
        };

        // Get current translation
        const t = () => translations[state.language];

        // Predefined LinkedIn account (like Apple)
        const linkedInAccount = {
            id: 1,
            name: 'Max Mustermann',
            email: 'max.mustermann@linkedin.com',
            avatar: 'MM',
            data: {
                titel: 'Dr.',
                vorname: 'Max',
                nachname: 'Mustermann',
                email: 'max.mustermann@example.com',
                telefon: '+49 123 456789',
                fachbereich: 'informatik',
                betreff: 'Bewerbung für Professur',
                nachricht: 'Ich interessiere mich für die ausgeschriebene Position.',
                datenschutz: true
            }
        };

        // Validation
        function validateStep(step) {
            const newErrors = {};
            const currentT = t();
            
            if (step === 1) {
                if (!state.formData.vorname.trim()) newErrors.vorname = currentT.required;
                if (!state.formData.nachname.trim()) newErrors.nachname = currentT.required;
                if (!state.formData.email.trim()) {
                    newErrors.email = currentT.required;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(state.formData.email)) {
                    newErrors.email = currentT.invalidEmail;
                }
                if (!state.formData.fachbereich) newErrors.fachbereich = currentT.required;
                if (!state.formData.betreff.trim()) newErrors.betreff = currentT.required;
                if (!state.formData.datenschutz) newErrors.datenschutz = currentT.required;
            }
            
            if (step === 2) {
                if (state.uploadedFiles.length === 0) {
                    newErrors.files = currentT.required;
                }
            }
            
            state.errors = newErrors;
            render();
            return Object.keys(newErrors).length === 0;
        }

        // Event Handlers
        window.selectMode = function(mode) {
            state.selectedMode = mode;
            render();
            
            if (mode === 'ai') {
                // Start chatbot if AI mode selected
                setTimeout(() => {
                    state.chatOpen = true;
                    state.currentQuestionIndex = 0;
                    state.chatMessages = [];
                    state.chatCompleted = false;
                    startChat();
                    render();
                }, 300);
            } else if (mode === 'linkedin') {
                // Show LinkedIn login first
                state.linkedinLoginShow = true;
                render();
            }
        };

        // LinkedIn data collection function
        function startLinkedInDataCollection() {
            state.linkedinLoading = true;
            state.linkedinProgress = 0;
            render();

            // Simulate progress
            const progressInterval = setInterval(() => {
                state.linkedinProgress += Math.random() * 15;
                if (state.linkedinProgress > 100) {
                    state.linkedinProgress = 100;
                }
                render();

                if (state.linkedinProgress >= 100) {
                    clearInterval(progressInterval);
                    // Fill form with data after loading
                    setTimeout(() => {
                        fillLinkedInData();
                        state.linkedinLoading = false;
                        state.currentStep = 1;
                        render();
                    }, 500);
                }
            }, 200);
        }

        // Fill form with LinkedIn data
        function fillLinkedInData() {
            state.formData = linkedInAccount.data;
        }

        // Handle LinkedIn login continue
        window.continueLinkedInLogin = function() {
            state.selectedLinkedInAccount = linkedInAccount.id;
            state.linkedinLoginShow = false;
            startLinkedInDataCollection();
        };

        // Handle LinkedIn login cancel
        window.cancelLinkedInLogin = function() {
            state.linkedinLoginShow = false;
            state.selectedLinkedInAccount = null;
            state.selectedMode = null;
            render();
        };

        window.saveAndContinue = function() {
            if (state.selectedMode) {
                state.currentStep = 1;
                render();
            }
        };

        window.handleNext = function() {
            if (state.currentStep === 0) {
                if (state.selectedMode) {
                    state.currentStep = 1;
                    render();
                }
            } else if (validateStep(state.currentStep)) {
                state.currentStep = Math.min(state.currentStep + 1, 3);
                render();
            }
        };

        window.handleBack = function() {
            state.currentStep = Math.max(state.currentStep - 1, 0);
            state.errors = {};
            render();
        };

        window.goToStep = function(step) {
            // Allow navigation to any step
            if (step >= 0 && step <= 3) {
                // If going back to a completed step or staying at current step, just navigate
                if (step <= state.currentStep) {
                    state.currentStep = step;
                    state.errors = {};
                    render();
                } else if (step === state.currentStep + 1) {
                    // If going forward one step, validate current step first
                    if (validateStep(state.currentStep)) {
                        state.currentStep = step;
                        state.errors = {};
                        render();
                    }
                }
                // If trying to skip steps forward, don't allow
            }
        };

        function handleInputChange(field, value) {
            state.formData[field] = value;
            if (state.errors[field]) {
                delete state.errors[field];
            }
            // Don't render on every keystroke - only update state
        }

        function handleFileUpload(e) {
            const files = Array.from(e.target.files || e.dataTransfer?.files || []);
            const validFiles = files.filter(file => {
                const isValidType = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type);
                const isValidSize = file.size <= 10 * 1024 * 1024;
                return isValidType && isValidSize;
            });
            
            state.uploadedFiles = [...state.uploadedFiles, ...validFiles];
            if (state.errors.files) {
                delete state.errors.files;
            }
            render();
        }

        function handleDrop(e) {
            e.preventDefault();
            state.isDragging = false;
            handleFileUpload(e);
        }

        window.removeFile = function(index) {
            state.uploadedFiles = state.uploadedFiles.filter((_, i) => i !== index);
            render();
        };

        window.handleSubmit = function() {
            if (validateStep(2)) {
                state.showSuccess = true;
                render();
                setTimeout(() => {
                    state.formData = {
                        titel: '',
                        vorname: '',
                        nachname: '',
                        email: '',
                        telefon: '',
                        fachbereich: '',
                        betreff: '',
                        nachricht: '',
                        datenschutz: false
                    };
                    state.uploadedFiles = [];
                    state.currentStep = 1;
                    state.showSuccess = false;
                    render();
                }, 5000);
            }
        };

        window.saveDraft = function() {
            alert(state.language === 'de' ? 'Entwurf gespeichert!' : 'Draft saved!');
        };

        window.toggleLanguage = function() {
            state.language = state.language === 'de' ? 'en' : 'de';
            render();
        };

        window.extendSession = function() {
            state.lastActivity = Date.now();
            state.sessionWarning = false;
            render();
        };

        // Chat Functions
        function startChat() {
            const questions = chatQuestions[state.language];
            if (questions && questions.length > 0) {
                const firstQuestion = questions[0];
                addBotMessage(firstQuestion.question);
            }
        }

        function addBotMessage(message) {
            state.chatMessages.push({ type: 'bot', text: message, timestamp: Date.now() });
            render();
            setTimeout(() => {
                const chatContainer = document.getElementById('chatMessages');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                const chatInput = document.getElementById('chatInput');
                if (chatInput && !state.chatCompleted) {
                    chatInput.focus();
                }
            }, 100);
        }

        function addUserMessage(message) {
            state.chatMessages.push({ type: 'user', text: message, timestamp: Date.now() });
            render();
            setTimeout(() => {
                const chatContainer = document.getElementById('chatMessages');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 100);
        }

        function processAnswer(answer) {
            const questions = chatQuestions[state.language];
            const currentQuestion = questions[state.currentQuestionIndex];
            
            if (!currentQuestion) return;

            // Process answer based on question type
            if (currentQuestion.isComplete) {
                // Form is complete, move to next step
                state.chatCompleted = true;
                addBotMessage(state.language === 'de' ? 'Perfekt! Ich habe alle Informationen. Sie können jetzt fortfahren.' : 'Perfect! I have all the information. You can now continue.');
                setTimeout(() => {
                    state.currentStep = 1;
                    state.chatOpen = true; // Keep chat open to show completion
                    render();
                }, 2000);
                return;
            }

            if (currentQuestion.isConfirm) {
                // Handle yes/no for privacy policy
                const isYes = answer.toLowerCase().includes('ja') || answer.toLowerCase().includes('yes') || answer.toLowerCase() === 'j' || answer.toLowerCase() === 'y';
                state.formData.datenschutz = isYes;
            } else if (currentQuestion.field === 'fachbereich') {
                // Map answer to fachbereich value
                const fachbereichMap = {
                    de: { 'informatik': 'informatik', 'wirtschaft': 'wirtschaft', 'technik': 'technik', 'gestaltung': 'design', 'design': 'design' },
                    en: { 'computer science': 'informatik', 'business': 'wirtschaft', 'engineering': 'technik', 'design': 'design' }
                };
                const answerLower = answer.toLowerCase();
                for (const [key, value] of Object.entries(fachbereichMap[state.language])) {
                    if (answerLower.includes(key)) {
                        state.formData.fachbereich = value;
                        break;
                    }
                }
            } else if (currentQuestion.field && answer.trim() !== '') {
                // Regular field - skip if empty and optional
                if (currentQuestion.field === 'telefon' || currentQuestion.field === 'titel' || currentQuestion.field === 'nachricht') {
                    if (answer.trim() !== '') {
                        state.formData[currentQuestion.field] = answer.trim();
                    }
                } else {
                    state.formData[currentQuestion.field] = answer.trim();
                }
            }

            // Move to next question
            state.currentQuestionIndex++;
            
            if (state.currentQuestionIndex < questions.length) {
                setTimeout(() => {
                    const nextQuestion = questions[state.currentQuestionIndex];
                    addBotMessage(nextQuestion.question);
                }, 500);
            } else {
                state.chatCompleted = true;
                addBotMessage(state.language === 'de' ? 'Perfekt! Ich habe alle Informationen. Sie können jetzt fortfahren.' : 'Perfect! I have all the information. You can now continue.');
                setTimeout(() => {
                    state.currentStep = 1;
                    state.chatOpen = true; // Keep chat open
                    render();
                }, 1500);
            }
        }

        window.toggleChat = function() {
            state.chatOpen = !state.chatOpen;
            if (state.chatOpen && state.chatMessages.length === 0 && state.selectedMode === 'ai') {
                startChat();
            }
            render();
        };

        window.sendChatMessage = function() {
            const input = document.getElementById('chatInput');
            if (input && input.value.trim() !== '' && !state.chatCompleted) {
                const message = input.value.trim();
                input.value = '';
                addUserMessage(message);
                
                // Process answer
                setTimeout(() => {
                    processAnswer(message);
                }, 300);
            }
        };

        // Render Functions
        function renderStep0() {
            const currentT = t();
            return `
                <div class="max-w-5xl mx-auto">
                    <div class="text-center mb-12">
                        <h2 class="text-4xl font-bold text-slate-800 mb-4">${currentT.step0Title}</h2>
                        <p class="text-slate-600 text-xl max-w-2xl mx-auto">${currentT.step0Description}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
                        <button onclick="selectMode('ai')" class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 ease-out border-2 ${state.selectedMode === 'ai' ? 'border-orange-500 bg-gradient-to-br from-orange-50 to-white scale-[1.02]' : 'border-slate-200 hover:border-[#86bc26]'} text-left transform hover:-translate-y-2 hover:scale-[1.02] p-8">
                            <div class="flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 ease-out shadow-lg group-hover:shadow-xl">
                                    <span class="w-12 h-12 text-white transition-all duration-500 ease-out group-hover:scale-110">${icons.bot}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold text-slate-800 mb-3 group-hover:text-orange-600 transition-colors duration-300">${currentT.step0AIOption}</h3>
                                    <p class="text-slate-600 text-base leading-relaxed">${currentT.step0AIDescription}</p>
                                </div>
                            </div>
                            ${state.selectedMode === 'ai' ? `
                                <div class="absolute top-4 right-4 flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-full shadow-md">
                                    <span class="w-5 h-5">${icons.check}</span>
                                    <span class="text-sm font-semibold">${state.language === 'de' ? 'Ausgewählt' : 'Selected'}</span>
                                </div>
                            ` : ''}
                        </button>
                        
                        <button onclick="selectMode('manual')" class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 ease-out border-2 ${state.selectedMode === 'manual' ? 'border-orange-500 bg-gradient-to-br from-orange-50 to-white scale-[1.02]' : 'border-slate-200 hover:border-[#86bc26]'} text-left transform hover:-translate-y-2 hover:scale-[1.02] p-8">
                            <div class="flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 ease-out shadow-lg group-hover:shadow-xl">
                                    <span class="w-12 h-12 text-white transition-all duration-500 ease-out group-hover:scale-110">${icons.save}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold text-slate-800 mb-3 group-hover:text-orange-600 transition-colors duration-300">${currentT.step0ManualOption}</h3>
                                    <p class="text-slate-600 text-base leading-relaxed">${currentT.step0ManualDescription}</p>
                                </div>
                            </div>
                            ${state.selectedMode === 'manual' ? `
                                <div class="absolute top-4 right-4 flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-full shadow-md">
                                    <span class="w-5 h-5">${icons.check}</span>
                                    <span class="text-sm font-semibold">${state.language === 'de' ? 'Ausgewählt' : 'Selected'}</span>
                                </div>
                            ` : ''}
                        </button>
                        
                        <button onclick="selectMode('linkedin')" class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 ease-out border-2 ${state.selectedMode === 'linkedin' ? 'border-orange-500 bg-gradient-to-br from-orange-50 to-white scale-[1.02]' : 'border-slate-200 hover:border-[#86bc26]'} text-left transform hover:-translate-y-2 hover:scale-[1.02] p-8">
                            <div class="flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 ease-out shadow-lg group-hover:shadow-xl">
                                    <span class="w-12 h-12 text-white transition-all duration-500 ease-out group-hover:scale-110">${icons.linkedin}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold text-slate-800 mb-3 group-hover:text-orange-600 transition-colors duration-300">${currentT.step0LinkedInOption}</h3>
                                    <p class="text-slate-600 text-base leading-relaxed">${currentT.step0LinkedInDescription}</p>
                                </div>
                            </div>
                            ${state.selectedMode === 'linkedin' ? `
                                <div class="absolute top-4 right-4 flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-full shadow-md">
                                    <span class="w-5 h-5">${icons.check}</span>
                                    <span class="text-sm font-semibold">${state.language === 'de' ? 'Ausgewählt' : 'Selected'}</span>
                                </div>
                            ` : ''}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSuccess() {
            const currentT = t();
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
                        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <span class="w-12 h-12 text-white">${icons.check}</span>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-4">${currentT.successTitle}</h2>
                        <p class="text-slate-600 text-lg">${currentT.successMessage}</p>
                    </div>
                </div>
            `;
        }

        function renderStep1() {
            const currentT = t();
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">${currentT.step1}</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">${currentT.titel}</label>
                            <input
                                type="text"
                                id="titel"
                                value="${state.formData.titel}"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition-all"
                                placeholder="Prof. Dr."
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                ${currentT.vorname} <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="vorname"
                                value="${state.formData.vorname}"
                                class="w-full px-4 py-3 border-2 rounded-lg outline-none transition-all ${state.errors.vorname ? 'border-red-500 focus:ring-red-200' : 'border-slate-200 focus:border-orange-500 focus:ring-orange-200'} focus:ring-2"
                            />
                            ${state.errors.vorname ? `<p class="text-red-500 text-sm mt-1">${state.errors.vorname}</p>` : ''}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                ${currentT.nachname} <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="nachname"
                                value="${state.formData.nachname}"
                                class="w-full px-4 py-3 border-2 rounded-lg outline-none transition-all ${state.errors.nachname ? 'border-red-500 focus:ring-red-200' : 'border-slate-200 focus:border-orange-500 focus:ring-orange-200'} focus:ring-2"
                            />
                            ${state.errors.nachname ? `<p class="text-red-500 text-sm mt-1">${state.errors.nachname}</p>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                ${currentT.email} <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="email"
                                id="email"
                                value="${state.formData.email}"
                                class="w-full px-4 py-3 border-2 rounded-lg outline-none transition-all ${state.errors.email ? 'border-red-500 focus:ring-red-200' : 'border-slate-200 focus:border-orange-500 focus:ring-orange-200'} focus:ring-2"
                            />
                            ${state.errors.email ? `<p class="text-red-500 text-sm mt-1">${state.errors.email}</p>` : ''}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">${currentT.telefon}</label>
                            <input
                                type="tel"
                                id="telefon"
                                value="${state.formData.telefon}"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition-all"
                            />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            ${currentT.fachbereich} <span class="text-red-500">*</span>
                        </label>
                        <select
                            id="fachbereich"
                            class="w-full px-4 py-3 border-2 rounded-lg outline-none transition-all ${state.errors.fachbereich ? 'border-red-500 focus:ring-red-200' : 'border-slate-200 focus:border-orange-500 focus:ring-orange-200'} focus:ring-2"
                        >
                            <option value="">${currentT.selectOption}</option>
                            <option value="informatik" ${state.formData.fachbereich === 'informatik' ? 'selected' : ''}>${currentT.fachbereiche.informatik}</option>
                            <option value="wirtschaft" ${state.formData.fachbereich === 'wirtschaft' ? 'selected' : ''}>${currentT.fachbereiche.wirtschaft}</option>
                            <option value="technik" ${state.formData.fachbereich === 'technik' ? 'selected' : ''}>${currentT.fachbereiche.technik}</option>
                            <option value="design" ${state.formData.fachbereich === 'design' ? 'selected' : ''}>${currentT.fachbereiche.design}</option>
                        </select>
                        ${state.errors.fachbereich ? `<p class="text-red-500 text-sm mt-1">${state.errors.fachbereich}</p>` : ''}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            ${currentT.betreff} <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="betreff"
                            value="${state.formData.betreff}"
                            class="w-full px-4 py-3 border-2 rounded-lg outline-none transition-all ${state.errors.betreff ? 'border-red-500 focus:ring-red-200' : 'border-slate-200 focus:border-orange-500 focus:ring-orange-200'} focus:ring-2"
                        />
                        ${state.errors.betreff ? `<p class="text-red-500 text-sm mt-1">${state.errors.betreff}</p>` : ''}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">${currentT.nachricht}</label>
                        <textarea
                            id="nachricht"
                            rows="4"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition-all resize-none"
                        >${state.formData.nachricht}</textarea>
                    </div>

                    <div class="flex items-start gap-3">
                        <input
                            type="checkbox"
                            id="datenschutz"
                            ${state.formData.datenschutz ? 'checked' : ''}
                            class="w-5 h-5 mt-1 accent-orange-500"
                        />
                        <label for="datenschutz" class="text-sm ${state.errors.datenschutz ? 'text-red-500' : 'text-slate-700'}">
                            ${currentT.datenschutz} <span class="text-red-500">*</span>
                        </label>
                    </div>
                    ${state.errors.datenschutz ? `<p class="text-red-500 text-sm">${state.errors.datenschutz}</p>` : ''}
                </div>
            `;
        }

        function renderStep2() {
            const currentT = t();
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">${currentT.uploadTitle}</h2>
                    
                    <div
                        id="dropZone"
                        class="border-3 border-dashed rounded-xl p-12 text-center transition-all ${state.isDragging ? 'border-orange-500 bg-orange-50' : state.errors.files ? 'border-red-500 bg-red-50' : 'border-slate-300 bg-slate-50'}"
                    >
                        <span class="w-16 h-16 mx-auto mb-4 block ${state.isDragging ? 'text-orange-500' : 'text-slate-400'}">${icons.upload}</span>
                        <p class="text-lg font-semibold text-slate-700 mb-2">${currentT.uploadDesc}</p>
                        <p class="text-sm text-slate-500 mb-4">${currentT.uploadFormats}</p>
                        <input
                            type="file"
                            id="fileUpload"
                            multiple
                            accept=".pdf,.doc,.docx"
                            class="hidden"
                        />
                        <label
                            for="fileUpload"
                            class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-3 rounded-lg cursor-pointer transition-colors"
                        >
                            ${currentT.selectFiles}
                        </label>
                    </div>
                    ${state.errors.files ? `<p class="text-red-500 text-sm">${state.errors.files}</p>` : ''}

                    ${state.uploadedFiles.length > 0 ? `
                        <div class="mt-6">
                            <h3 class="font-semibold text-slate-800 mb-3">${currentT.uploadedFiles}</h3>
                            <div class="space-y-2">
                                ${state.uploadedFiles.map((file, index) => `
                                    <div class="flex items-center justify-between bg-slate-50 p-4 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                                <span class="w-5 h-5 text-orange-600">${icons.upload}</span>
                                            </div>
                                            <div>
                                                <p class="font-medium text-slate-800">${file.name}</p>
                                                <p class="text-sm text-slate-500">${(file.size / 1024).toFixed(2)} KB</p>
                                            </div>
                                        </div>
                                        <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                                            <span class="w-5 h-5">${icons.x}</span>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep3() {
            const currentT = t();
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">${currentT.reviewTitle}</h2>
                    
                    <div class="bg-slate-50 rounded-lg p-6">
                        <h3 class="font-semibold text-lg text-slate-800 mb-4">${currentT.reviewPersonal}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            ${state.formData.titel ? `
                                <div>
                                    <span class="font-semibold text-slate-600">${currentT.titel}:</span>
                                    <span class="ml-2 text-slate-800">${state.formData.titel}</span>
                                </div>
                            ` : ''}
                            <div>
                                <span class="font-semibold text-slate-600">${currentT.vorname}:</span>
                                <span class="ml-2 text-slate-800">${state.formData.vorname}</span>
                            </div>
                            <div>
                                <span class="font-semibold text-slate-600">${currentT.nachname}:</span>
                                <span class="ml-2 text-slate-800">${state.formData.nachname}</span>
                            </div>
                            <div>
                                <span class="font-semibold text-slate-600">${currentT.email}:</span>
                                <span class="ml-2 text-slate-800">${state.formData.email}</span>
                            </div>
                            ${state.formData.telefon ? `
                                <div>
                                    <span class="font-semibold text-slate-600">${currentT.telefon}:</span>
                                    <span class="ml-2 text-slate-800">${state.formData.telefon}</span>
                                </div>
                            ` : ''}
                            <div>
                                <span class="font-semibold text-slate-600">${currentT.fachbereich}:</span>
                                <span class="ml-2 text-slate-800">${currentT.fachbereiche[state.formData.fachbereich]}</span>
                            </div>
                            <div class="md:col-span-2">
                                <span class="font-semibold text-slate-600">${currentT.betreff}:</span>
                                <span class="ml-2 text-slate-800">${state.formData.betreff}</span>
                            </div>
                            ${state.formData.nachricht ? `
                                <div class="md:col-span-2">
                                    <span class="font-semibold text-slate-600">${currentT.nachricht}:</span>
                                    <p class="mt-2 text-slate-800">${state.formData.nachricht}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-lg p-6">
                        <h3 class="font-semibold text-lg text-slate-800 mb-4">${currentT.reviewDocuments}</h3>
                        <div class="space-y-2">
                            ${state.uploadedFiles.map((file, index) => `
                                <div class="flex items-center gap-3">
                                    <span class="w-5 h-5 text-green-500">${icons.check}</span>
                                    <span class="text-slate-800">${file.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const currentT = t();
            const app = document.getElementById('app');
            
            // Preserve input values before rendering (in case user is typing)
            if (state.currentStep === 1) {
                ['titel', 'vorname', 'nachname', 'email', 'telefon', 'fachbereich', 'betreff', 'nachricht'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value !== undefined) {
                        state.formData[id] = el.value;
                    }
                });
                const datenschutz = document.getElementById('datenschutz');
                if (datenschutz) {
                    state.formData.datenschutz = datenschutz.checked;
                }
            }
            
            if (state.showSuccess) {
                app.innerHTML = renderSuccess();
                return;
            }

            // LinkedIn Login Modal - Minimalistisch wie Apple
            const linkedinLoginModal = state.linkedinLoginShow ? `
                <div class="fixed inset-0 bg-black/30 flex items-center justify-center z-[60] backdrop-blur-sm">
                    <div class="bg-white rounded-3xl shadow-xl max-w-sm w-full mx-4 overflow-hidden">
                        <div class="px-8 pt-10 pb-6 text-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="w-9 h-9 text-white">${icons.linkedin}</span>
                            </div>
                            <h3 class="text-2xl font-semibold text-slate-900 mb-2">${currentT.linkedinLoginTitle}</h3>
                            <p class="text-slate-500 text-sm">${currentT.linkedinLoginDescription}</p>
                        </div>
                        <div class="px-6 pb-6">
                            <button onclick="continueLinkedInLogin()" class="w-full flex items-center gap-4 p-4 rounded-xl hover:bg-slate-50 transition-colors border border-slate-200">
                                <div class="w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center text-white font-semibold text-lg flex-shrink-0">
                                    ${linkedInAccount.avatar}
                                </div>
                                <div class="flex-1 text-left">
                                    <div class="font-medium text-slate-900">${linkedInAccount.name}</div>
                                    <div class="text-sm text-slate-500">${linkedInAccount.email}</div>
                                </div>
                                <span class="w-5 h-5 text-slate-400">${icons.chevronRight}</span>
                            </button>
                        </div>
                        <div class="px-6 pb-8 pt-2">
                            <button onclick="cancelLinkedInLogin()" class="w-full py-3 text-slate-600 hover:text-slate-900 font-medium text-sm transition-colors">
                                ${currentT.linkedinLoginCancel}
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            // LinkedIn Loading Modal
            const linkedinModal = state.linkedinLoading ? `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] backdrop-blur-sm">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="w-12 h-12 text-white">${icons.linkedin}</span>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2">${state.language === 'de' ? 'Informationen sammeln' : 'Collecting information'}</h3>
                            <p class="text-slate-600">${state.language === 'de' ? 'Bitte warten Sie, während wir Ihre LinkedIn-Daten abrufen...' : 'Please wait while we retrieve your LinkedIn data...'}</p>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-3 mb-4 overflow-hidden">
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 h-full rounded-full transition-all duration-300 ease-out" style="width: ${state.linkedinProgress}%"></div>
                        </div>
                        <div class="text-center">
                            <span class="text-sm font-semibold text-slate-700">${Math.round(state.linkedinProgress)}%</span>
                        </div>
                    </div>
                </div>
            ` : '';

            // Chat Widget HTML - show if AI mode is selected and we're in step 0 or 1
            const chatWidget = (state.selectedMode === 'ai' && (state.currentStep === 0 || state.currentStep === 1)) ? `
                ${!state.chatOpen ? `
                    <button onclick="toggleChat()" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-all duration-300 z-50 group">
                        <span class="w-8 h-8">${icons.messageCircle}</span>
                        ${state.chatMessages.length > 0 && !state.chatCompleted ? `
                            <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                        ` : ''}
                    </button>
                ` : `
                    <div class="fixed bottom-6 right-6 w-96 h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col z-50 border-2 border-slate-200">
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-t-2xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-8">${icons.bot}</span>
                                <div>
                                    <h3 class="font-bold">${state.language === 'de' ? 'KI Assistent' : 'AI Assistant'}</h3>
                                    <p class="text-xs text-orange-100">${state.language === 'de' ? 'Bereit zu helfen' : 'Ready to help'}</p>
                                </div>
                            </div>
                            <button onclick="toggleChat()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                                <span class="w-5 h-5">${icons.x}</span>
                            </button>
                        </div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                            ${state.chatMessages.map(msg => `
                                <div class="flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}">
                                    <div class="max-w-[80%] ${msg.type === 'user' ? 'bg-orange-500 text-white' : 'bg-white text-slate-800'} rounded-2xl px-4 py-2 shadow-md">
                                        ${msg.type === 'bot' ? `<div class="flex items-center gap-2 mb-1"><span class="w-4 h-4">${icons.bot}</span><span class="text-xs font-semibold">KI</span></div>` : ''}
                                        <p class="text-sm">${msg.text}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${!state.chatCompleted ? `
                            <div class="p-4 border-t-2 border-slate-200 bg-white rounded-b-2xl">
                                <div class="flex gap-2">
                                    <input type="text" id="chatInput" placeholder="${state.language === 'de' ? 'Ihre Antwort...' : 'Your answer...'}" 
                                           onkeypress="if(event.key === 'Enter') sendChatMessage()"
                                           class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-[#86bc26] outline-none transition-all">
                                    <button onclick="sendChatMessage()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all shadow-md hover:shadow-lg">
                                        <span class="w-5 h-5">${icons.send}</span>
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="p-4 border-t-2 border-slate-200 bg-green-50 rounded-b-2xl text-center">
                                <p class="text-sm text-green-700 font-semibold">${state.language === 'de' ? '✓ Formular ausgefüllt!' : '✓ Form completed!'}</p>
                            </div>
                        `}
                    </div>
                `}
            ` : '';

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
                    ${linkedinLoginModal}
                    ${linkedinModal}
                    ${chatWidget}
                    ${state.sessionWarning ? `
                        <div class="fixed top-4 right-4 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-4">
                            <span class="w-6 h-6">${icons.alertCircle}</span>
                            <span>${currentT.sessionWarning}</span>
                            <button onclick="extendSession()" class="bg-white text-orange-500 px-4 py-2 rounded-lg font-semibold hover:bg-orange-50 transition-colors">
                                ${currentT.extend}
                            </button>
                        </div>
                    ` : ''}

                    <header class="bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg">
                        <div class="max-w-6xl mx-auto px-4 py-6 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <img src="Bildschirmfoto 2025-11-03 um 16.06.18.png" alt="Logo" class="h-16 object-contain">
                                <div>
                                    <h1 class="text-2xl font-bold">${currentT.title}</h1>
                                    <p class="text-orange-100 text-sm">${currentT.subtitle}</p>
                                </div>
                            </div>
                            <button onclick="toggleLanguage()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                                <span class="w-5 h-5">${icons.globe}</span>
                                <span class="font-semibold">${state.language === 'de' ? 'EN' : 'DE'}</span>
                            </button>
                        </div>
                    </header>

                    <main class="max-w-4xl mx-auto px-4 py-8">
                        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-sm font-semibold text-slate-600">
                                    ${currentT.progress} ${state.currentStep + 1} ${currentT.of} 4
                                </span>
                                <span class="text-sm font-semibold text-orange-600">
                                    ${Math.round(((state.currentStep + 1) / 4) * 100)}%
                                </span>
                            </div>
                            <div class="relative">
                                <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-orange-500 to-orange-600 transition-all duration-500 ease-out" style="width: ${((state.currentStep + 1) / 4) * 100}%"></div>
                                </div>
                                <div class="flex justify-between mt-3">
                                    ${[0, 1, 2, 3].map((step) => `
                                        <button onclick="goToStep(${step})" class="flex items-center justify-center w-8 h-8 rounded-full font-semibold text-sm transition-all cursor-pointer hover:scale-110 ${step <= state.currentStep ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-slate-200 text-slate-500 hover:bg-slate-300'}">
                                            ${step < state.currentStep ? `<span class="w-5 h-5">${icons.check}</span>` : step + 1}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex justify-between mt-2">
                                <span class="text-xs font-medium ${state.currentStep >= 0 ? 'text-orange-600' : 'text-slate-500'}">
                                    ${currentT.step0}
                                </span>
                                <span class="text-xs font-medium ${state.currentStep >= 1 ? 'text-orange-600' : 'text-slate-500'}">
                                    ${currentT.step1}
                                </span>
                                <span class="text-xs font-medium ${state.currentStep >= 2 ? 'text-orange-600' : 'text-slate-500'}">
                                    ${currentT.step2}
                                </span>
                                <span class="text-xs font-medium ${state.currentStep >= 3 ? 'text-orange-600' : 'text-slate-500'}">
                                    ${currentT.step3}
                                </span>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-8">
                            ${state.currentStep === 0 ? renderStep0() : ''}
                            ${state.currentStep === 1 ? renderStep1() : ''}
                            ${state.currentStep === 2 ? renderStep2() : ''}
                            ${state.currentStep === 3 ? renderStep3() : ''}

                            ${state.currentStep === 0 ? `
                                <div class="flex justify-center items-center mt-12 pt-8">
                                    <button onclick="saveAndContinue()" ${!state.selectedMode ? 'disabled' : ''} class="flex items-center gap-3 px-10 py-4 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold rounded-xl transition-all duration-300 shadow-lg hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                                        <span class="w-6 h-6">${icons.save}</span>
                                        ${currentT.saveAndContinue}
                                        <span class="w-6 h-6">${icons.chevronRight}</span>
                                    </button>
                                </div>
                            ` : ''}
                            ${state.currentStep > 0 ? `
                            <div class="flex justify-between items-center mt-8 pt-6 border-t-2 border-slate-200">
                                <div class="flex gap-3">
                                    <button onclick="handleBack()" class="flex items-center gap-2 px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition-colors">
                                        <span class="w-5 h-5">${icons.chevronLeft}</span>
                                        ${currentT.back}
                                    </button>
                                    <button onclick="saveDraft()" class="flex items-center gap-2 px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-lg transition-colors">
                                        <span class="w-5 h-5">${icons.save}</span>
                                        ${currentT.save}
                                    </button>
                                </div>
                                
                                ${state.currentStep < 3 ? `
                                    <button onclick="handleNext()" class="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold rounded-lg transition-all shadow-lg">
                                        ${currentT.next}
                                        <span class="w-5 h-5">${icons.chevronRight}</span>
                                    </button>
                                ` : `
                                    <button onclick="handleSubmit()" class="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg transition-all shadow-lg">
                                        <span class="w-5 h-5">${icons.check}</span>
                                        ${currentT.submit}
                                    </button>
                                    `}
                            </div>
                            ` : ''}
                        </div>
                    </main>
                </div>
            `;

            // Attach event listeners
            attachEventListeners();
        }

        function attachEventListeners() {
            // Chat input listener
            const chatInput = document.getElementById('chatInput');
            if (chatInput && !chatInput.dataset.listenerAttached) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.sendChatMessage();
                    }
                });
                chatInput.dataset.listenerAttached = 'true';
            }

            // Step 1 inputs - only attach if not already attached
            if (state.currentStep === 1) {
                ['titel', 'vorname', 'nachname', 'email', 'telefon', 'fachbereich', 'betreff'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.dataset.listenerAttached) {
                        el.addEventListener('input', (e) => {
                            handleInputChange(id, e.target.value);
                        });
                        el.dataset.listenerAttached = 'true';
                    }
                });
                
                const nachricht = document.getElementById('nachricht');
                if (nachricht && !nachricht.dataset.listenerAttached) {
                    nachricht.addEventListener('input', (e) => {
                        handleInputChange('nachricht', e.target.value);
                    });
                    nachricht.dataset.listenerAttached = 'true';
                }
                
                const datenschutz = document.getElementById('datenschutz');
                if (datenschutz && !datenschutz.dataset.listenerAttached) {
                    datenschutz.addEventListener('change', (e) => {
                        handleInputChange('datenschutz', e.target.checked);
                    });
                    datenschutz.dataset.listenerAttached = 'true';
                }
            }

            // Step 2 file upload
            if (state.currentStep === 2) {
                const fileUpload = document.getElementById('fileUpload');
                if (fileUpload && !fileUpload.dataset.listenerAttached) {
                    fileUpload.addEventListener('change', handleFileUpload);
                    fileUpload.dataset.listenerAttached = 'true';
                }

                const dropZone = document.getElementById('dropZone');
                if (dropZone && !dropZone.dataset.listenerAttached) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        state.isDragging = true;
                        render();
                    });
                    dropZone.addEventListener('dragleave', () => {
                        state.isDragging = false;
                        render();
                    });
                    dropZone.addEventListener('drop', handleDrop);
                    dropZone.dataset.listenerAttached = 'true';
                }
            }
        }

        // Session warning check
        setInterval(() => {
            const timeSinceActivity = Date.now() - state.lastActivity;
            const fiftyFiveMinutes = 55 * 60 * 1000;
            
            if (timeSinceActivity > fiftyFiveMinutes && !state.sessionWarning) {
                state.sessionWarning = true;
                render();
            }
        }, 60000);

        const resetTimer = () => {
            state.lastActivity = Date.now();
            if (state.sessionWarning) {
                state.sessionWarning = false;
                render();
            }
        };

        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('keypress', resetTimer);

        // Initial render
        render();
    </script>
</body>
</html>

